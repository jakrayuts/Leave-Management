<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î Supervisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; margin: 0; }
    .container { padding: 2rem; }
    h2 { margin-bottom: 1.5rem; }
    .card { box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 10px; }
    .badge { font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö -->
    <div class="d-flex justify-content-end mb-3">
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <h2>üë®‚Äçüíº ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Supervisor)</h2>

    <!-- ‡∏Å‡∏£‡∏≤‡∏ü -->
    <div class="card p-3 mb-4">
      <h5>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
      <canvas id="chartDeptLeave" height="200"></canvas>
    </div>

    <!-- ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ -->
    <div class="card p-3 mb-4">
      <h5>üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h5>
      <div class="table-responsive">
        <table class="table table-striped" id="pendingTable">
          <thead><tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
    <div class="card p-3">
      <h5>üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-sm" id="historyTable">
          <thead><tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabase = createClient(
      'https://bokajbbrctsuqeyvykgb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw'
    );

    let currentUser, currentDepartment;

    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return location.href = 'index.html';

      const { data: userInfo } = await supabase
        .from('users')
        .select('role, department')
        .eq('id', user.id)
        .maybeSingle();

      if (!userInfo || userInfo.role?.toLowerCase() !== 'supervisor') {
        console.warn('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:', userInfo?.role);
        return location.href = 'index.html';
      }

      currentUser = user;
      currentDepartment = userInfo.department;
      console.log('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Supervisor:', currentDepartment);

      await loadPendingRequests();
      await loadHistory();
      await loadChart();
    }

    async function loadPendingRequests() {
      const { data, error } = await supabase
        .from('leave_requests')
        .select('id, leave_type, date_start, date_end, leave_days, reason, user:user_id(name, department)')
        .eq('status', 'pending');

      if (error) return console.error('‡πÇ‡∏´‡∏•‡∏î pending ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
      if (!data) return;

      const filtered = data.filter(r => r.user?.department === currentDepartment);
      const tbody = document.querySelector('#pendingTable tbody');
      tbody.innerHTML = '';

      filtered.forEach(r => {
        tbody.innerHTML += `
          <tr>
            <td>${r.user.name}</td>
            <td>${r.leave_type}</td>
            <td>${formatDate(r.date_start)}</td>
            <td>${formatDate(r.date_end)}</td>
            <td>${r.leave_days}</td>
            <td>${r.reason || '-'}</td>
            <td>
              <button class="btn btn-sm btn-success me-1" onclick="handleDecision('${r.id}', 'approved')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button class="btn btn-sm btn-danger" onclick="handleDecision('${r.id}', 'rejected')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
            </td>
          </tr>`;
      });
    }

    async function loadHistory() {
      const { data, error } = await supabase
        .from('leave_requests')
        .select('leave_type, date_start, status, reason, user:user_id(name, department)')
        .in('status', ['approved', 'rejected']);

      if (error) return console.error('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
      if (!data) return;

      const filtered = data.filter(r => r.user?.department === currentDepartment);
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = '';

      filtered.forEach(r => {
        tbody.innerHTML += `
          <tr>
            <td>${r.user.name}</td>
            <td>${r.leave_type}</td>
            <td>${formatDate(r.date_start)}</td>
            <td><span class="badge bg-${r.status === 'approved' ? 'success' : 'danger'}">${r.status}</span></td>
            <td>${r.reason || '-'}</td>
          </tr>`;
      });
    }

    async function loadChart() {
      const { data, error } = await supabase
        .from('leave_requests')
        .select('leave_type, leave_days, date_start, user:user_id(department)')
        .eq('status', 'approved');

      if (error) return console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
      if (!data) return;

      const filtered = data.filter(r => r.user?.department === currentDepartment);
      const summary = {};

      filtered.forEach(r => {
        summary[r.leave_type] = (summary[r.leave_type] || 0) + r.leave_days;
      });

      const labels = Object.keys(summary);
      const values = Object.values(summary);

      const ctx = document.getElementById('chartDeptLeave').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤',
            data: values,
            backgroundColor: labels.map(() => `hsl(${Math.random() * 360}, 70%, 70%)`)
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' },
            legend: { display: false }
          }
        }
      });
    }

    window.handleDecision = async (id, status) => {
      await supabase.from('leave_requests').update({ status }).eq('id', id);
      await loadPendingRequests();
      await loadHistory();
      await loadChart();
    };

    function formatDate(d) {
      return new Date(d).toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }
document.getElementById('btnLogout').addEventListener('click', async () => {
  await supabase.auth.signOut();
  location.href = 'index.html';
});

    init();
  </script>
</body>
</html>
