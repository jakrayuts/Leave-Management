<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î Supervisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f9; margin: 0; }
    .container { padding: 2rem; }
    h2 { margin-bottom: 1.5rem; }
    .card { box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 10px; }
    .badge { font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-end mb-3">
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <h2>üë®‚Äçüíº ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Supervisor)</h2>

    <div class="card p-3 mb-4">
      <h5>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h5>
      <canvas id="chartDeptLeave" height="200"></canvas>
    </div>

    <div class="card p-3 mb-4">
      <h5>üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h5>
      <div class="table-responsive">
        <table class="table table-striped" id="pendingTable">
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card p-3">
      <h5>üïò ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-sm" id="historyTable">
          <thead>
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const supabase = createClient(
  'https://bokajbbrctsuqeyvykgb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw'
);

let currentUser, currentDepartment;
const userMap = {};

function normalize(text) {
  return (text || '').toLowerCase().trim();
}

async function init() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return location.href = 'index.html';

  const { data: userInfo } = await supabase
    .from('users')
    .select('role, department')
    .eq('id', user.id)
    .maybeSingle();

  if (!userInfo || normalize(userInfo.role) !== 'supervisor') {
    console.warn('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:', userInfo?.role);
    return location.href = 'index.html';
  }

  currentUser = user;
  currentDepartment = normalize(userInfo.department);

  const { data: allUsers, error } = await supabase.from('users').select('id, name, department');
  if (error) return console.error('‡πÇ‡∏´‡∏•‡∏î users ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);

  allUsers.forEach(u => {
    userMap[u.id] = {
      name: u.name,
      department: normalize(u.department)
    };
  });

  console.log("‚úÖ Logged in user:", user);
  console.log("‚úÖ User info:", userInfo);
  console.log("‚úÖ All users:", userMap);

  await loadPendingRequests();
  await loadHistory();
  await loadChart();
}

async function loadPendingRequests() {
  const { data, error } = await supabase
    .from('leave_requests')
    .select('*')
    .eq('status', 'pending');

  if (error) return console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
  console.log("üì• Raw leave_requests pending data:", data);

  const filtered = data.filter(r => normalize(userMap[r.user_id]?.department) === currentDepartment);
  console.log("‚úÖ Filtered pending requests:", filtered);

  renderLeaveRequestsTable(filtered);
}

async function loadHistory() {
  const { data, error } = await supabase
    .from('leave_requests')
    .select('*')
    .not('status', 'eq', 'pending');

  if (error) return console.error('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
  console.log("üìò Raw leave_requests history data:", data);

  const filtered = data.filter(r => normalize(userMap[r.user_id]?.department) === currentDepartment);
  console.log("üìó Filtered history requests:", filtered);

  renderLeaveHistoryTable(filtered);
}

async function loadChart() {
  const { data, error } = await supabase
    .from('leave_requests')
    .select('leave_type, leave_days, user_id')
    .eq('status', 'approved');

  if (error) return console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);

  const filtered = data.filter(r => normalize(userMap[r.user_id]?.department) === currentDepartment);

  const summary = {};
  filtered.forEach(r => {
    summary[r.leave_type] = (summary[r.leave_type] || 0) + r.leave_days;
  });

  const labels = Object.keys(summary);
  const values = Object.values(summary);
  const ctx = document.getElementById('chartDeptLeave').getContext('2d');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤',
        data: values,
        backgroundColor: labels.map(() => `hsl(${Math.random() * 360}, 70%, 70%)`)
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó' },
        legend: { display: false }
      }
    }
  });
}

function formatDate(d) {
  if (!d) return '-';
  return new Date(d).toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

function renderLeaveRequestsTable(data) {
  const tbody = document.querySelector('#pendingTable tbody');
  tbody.innerHTML = '';

  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</td></tr>`;
    return;
  }

  data.forEach(item => {
    const name = userMap[item.user_id]?.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
    tbody.innerHTML += `
      <tr>
        <td>${name}</td>
        <td>${item.leave_type}</td>
        <td>${formatDate(item.date_start)}</td>
        <td>${formatDate(item.date_end)}</td>
        <td>${item.leave_days}</td>
        <td>${item.reason}</td>
        <td>
          <button class="btn btn-success btn-sm" onclick="handleDecision('${item.id}', 'approved')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="btn btn-danger btn-sm" onclick="handleDecision('${item.id}', 'rejected')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        </td>
      </tr>
    `;
  });
}

function renderLeaveHistoryTable(data) {
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';

  if (data.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</td></tr>`;
    return;
  }

  data.forEach(item => {
    const name = userMap[item.user_id]?.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
    tbody.innerHTML += `
      <tr>
        <td>${name}</td>
        <td>${item.leave_type}</td>
        <td>${formatDate(item.date_start)}</td>
        <td>${item.status}</td>
        <td>${item.reason}</td>
      </tr>
    `;
  });
}

window.handleDecision = async (id, status) => {
  const { error } = await supabase.from('leave_requests').update({ status }).eq('id', id);
  if (error) {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
    console.error(error);
    return;
  }
  await loadPendingRequests();
  await loadHistory();
  await loadChart();
};

window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnLogout').addEventListener('click', async () => {
    await supabase.auth.signOut();
    location.href = 'index.html';
  });
  init();
});
</script>

</body>
</html>
