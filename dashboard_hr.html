<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>แดชบอร์ดแอดมิน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background-color: #f3f4f6;
    }

    /* Sidebar */
    #sidebar {
      width: 260px;
      background-color: #1E40AF; /* น้ำเงินเข้ม */
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 1.5rem;
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
    }
    #sidebar h3 {
      text-align: center;
      margin-bottom: 2rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: #DBEAFE; /* ฟ้าสว่าง */
    }
    #sidebar .nav-link {
      color: #BFDBFE; /* ฟ้าสว่างนิดๆ */
      padding: 1rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      border-left: 4px solid transparent;
    }
    #sidebar .nav-link:hover,
    #sidebar .nav-link.active {
      background-color: #3B82F6; /* ฟ้าอ่อนไฮไลท์ */
      color: #fff;
      border-left-color: #93C5FD;
    }

    /* Main content */
    #main-content {
      flex-grow: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .header h2 {
      color: #1E40AF;
      margin: 0;
    }

    /* Table */
    table {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
    }

    /* Role management */
    #rolesTable {
      margin-top: 1rem;
    }
    #rolesTable select {
      min-width: 120px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
      }
      #sidebar .nav-link {
        flex: 1;
        text-align: center;
        border-left: none;
        border-bottom: 3px solid transparent;
      }
      #sidebar .nav-link.active {
        border-left: none;
        border-bottom-color: #93C5FD;
      }
      #main-content {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>

  <nav id="sidebar">
    <h3>Admin Panel</h3>
    <div class="nav-link active" onclick="showSection('dashboard', event)">แดชบอร์ด</div>
    <div class="nav-link" onclick="showSection('requests', event)">คำขอลา</div>
    <div class="nav-link" onclick="showSection('roles', event)">จัดการสิทธิ์ผู้ใช้</div>
    <div class="nav-link" onclick="logout()">ออกจากระบบ</div>
  </nav>

  <div id="main-content">
    <!-- Dashboard Section -->
    <section id="dashboardSection">
      <div class="header">
        <h2>สรุปการลาแต่ละประเภท (รายเดือน)</h2>
      </div>
      <canvas id="leaveTypeChart" height="150"></canvas>
    </section>

    <!-- Leave Requests Section -->
    <section id="requestsSection" style="display:none;">
      <h3>คำขอลาทั้งหมด</h3>
      <table class="table table-striped" id="adminLeaveTable">
        <thead>
          <tr>
            <th>ชื่อ</th>
            <th>แผนก</th>
            <th>ประเภท</th>
            <th>เริ่ม</th>
            <th>สิ้นสุด</th>
            <th>จำนวนวัน</th>
            <th>โหมดลา</th>
            <th>เหตุผล</th>
            <th>สถานะ</th>
            <th>การจัดการ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Roles Management Section -->
    <section id="rolesSection" style="display:none;">
      <h3>จัดการสิทธิ์ผู้ใช้</h3>
      <table class="table table-hover" id="rolesTable">
        <thead>
          <tr>
            <th>ชื่อ</th>
            <th>อีเมล</th>
            <th>แผนก</th>
            <th>สถานะ</th>
            <th>สิทธิ์ (Role)</th>
            <th>บันทึก</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabase = createClient(
      'https://bokajbbrctsuqeyvykgb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw'
    );

    let chart = null;

    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return location.href = 'index.html';

      const { data: userInfo } = await supabase.from('users').select('role').eq('id', user.id).maybeSingle();
      const role = userInfo?.role?.toLowerCase();
      if (!['admin', 'hr'].includes(role)) return location.href = 'index.html';

      await loadLeaveRequests();
      await loadLeaveTypeChart();
      await loadUsersForRoles();
    }

    async function loadLeaveRequests() {
      const { data: leaveData, error } = await supabase.from('leave_requests').select('*').order('created_at', { ascending: false });
      if (error) {
        alert('โหลดข้อมูลล้มเหลว: ' + error.message);
        return;
      }

      const { data: users, error: usersError } = await supabase.from('users').select('id, name, department');
      if (usersError) {
        alert('โหลดข้อมูลผู้ใช้ล้มเหลว: ' + usersError.message);
        return;
      }

      const userMap = {};
      users.forEach(u => userMap[u.id] = { name: u.name || 'ไม่พบชื่อ', department: u.department || '-' });

      const tbody = document.querySelector('#adminLeaveTable tbody');
      tbody.innerHTML = '';

      leaveData.forEach(row => {
        const user = userMap[row.user_id] || { name: 'ไม่พบชื่อ', department: '-' };
        const start = `${formatDate(row.date_start)} ${row.time_start || ''}`;
        const end = `${formatDate(row.date_end)} ${row.time_end || ''}`;
        const mode = leaveModeLabel(row.leave_mode);
        const statusHtml = `<span class="badge bg-${statusColor(row.status)}">${row.status}</span>`;

        const buttons = row.status === 'pending' ? `
          <button class="btn btn-success btn-sm me-1" onclick="updateStatus('${row.id}', 'approved')">อนุมัติ</button>
          <button class="btn btn-danger btn-sm" onclick="updateStatus('${row.id}', 'rejected')">ปฏิเสธ</button>` : '-';

        tbody.innerHTML += `
          <tr>
            <td>${user.name}</td>
            <td>${user.department}</td>
            <td>${row.leave_type}</td>
            <td>${start}</td>
            <td>${end}</td>
            <td>${row.leave_days}</td>
            <td>${mode}</td>
            <td>${row.reason || '-'}</td>
            <td>${statusHtml}</td>
            <td>${buttons}</td>
          </tr>`;
      });
    }

    async function loadLeaveTypeChart() {
      const { data, error } = await supabase.from('leave_requests').select('leave_type, date_start, leave_days').eq('status', 'approved');
      if (error) return;

      const chartData = {};
      data.forEach(row => {
        const month = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
        const key = `${row.leave_type}-${month}`;
        chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
      });

      const months = [...new Set(data.map(r => new Date(r.date_start).toLocaleString('th-TH', { month: 'short' })))];
      const types = [...new Set(data.map(r => r.leave_type))];

      const datasets = types.map(type => ({
        label: type,
        data: months.map(month => chartData[`${type}-${month}`] || 0),
        backgroundColor: randomColor()
      }));

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('leaveTypeChart'), {
        type: 'bar',
        data: { labels: months, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'จำนวนวันลาแต่ละประเภท (รายเดือน)' }
          }
        }
      });
    }

    async function updateStatus(id, status) {
      const { error } = await supabase.from('leave_requests').update({ status }).eq('id', id);
      if (error) {
        alert('อัปเดตสถานะไม่สำเร็จ: ' + error.message);
        return;
      }
      await loadLeaveRequests();
      await loadLeaveTypeChart();
    }

    async function loadUsersForRoles() {
      const { data, error } = await supabase.from('users').select('id, name,department, role');
      if (error) {
        alert('โหลดข้อมูลผู้ใช้ล้มเหลว: ' + error.message);
        return;
      }
      const tbody = document.querySelector('#rolesTable tbody');
      tbody.innerHTML = '';

      data.forEach(user => {
        tbody.innerHTML += `
          <tr>
            <td>${user.name}</td>            
            <td>${user.department || '-'}</td>
            <td>${user.role || '-'}</td>
            <td>
              <select class="form-select form-select-sm" onchange="markRoleChange('${user.id}', this.value)">
                <option value="">-- เลือกสิทธิ์ --</option>
                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                <option value="hr" ${user.role === 'hr' ? 'selected' : ''}>HR</option>
                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                <option value="anon" ${user.role === 'anon' ? 'selected' : ''}>Anon</option>
              </select>
            </td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="saveRoleChange('${user.id}')">บันทึก</button>
            </td>
          </tr>`;
      });
    }

    const changedRoles = {};

    function markRoleChange(userId, newRole) {
      changedRoles[userId] = newRole;
    }

    async function saveRoleChange(userId) {
      const newRole = changedRoles[userId];
      if (!newRole) {
        alert('กรุณาเลือกสิทธิ์ก่อนบันทึก');
        return;
      }
      const { error } = await supabase.from('users').update({ role: newRole }).eq('id', userId);
      if (error) {
        alert('บันทึกสิทธิ์ไม่สำเร็จ: ' + error.message);
        return;
      }
      alert('บันทึกสิทธิ์สำเร็จ');
      delete changedRoles[userId];
      await loadUsersForRoles();
    }

    function formatDate(d) {
      return new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function leaveModeLabel(mode) {
      return { full: 'เต็มวัน', half_morning: 'ครึ่งวันเช้า', half_afternoon: 'ครึ่งวันบ่าย', hourly: 'รายชั่วโมง' }[mode] || '-';
    }

    function statusColor(status) {
      return { approved: 'success', rejected: 'danger', pending: 'secondary' }[status] || 'light';
    }

    function randomColor() {
      return 'hsl(' + Math.floor(Math.random() * 360) + ', 70%, 70%)';
    }

    function showSection(section, event) {
      document.getElementById('dashboardSection').style.display = section === 'dashboard' ? 'block' : 'none';
      document.getElementById('requestsSection').style.display = section === 'requests' ? 'block' : 'none';
      document.getElementById('rolesSection').style.display = section === 'roles' ? 'block' : 'none';

      document.querySelectorAll('#sidebar .nav-link').forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');
    }

    async function logout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        alert('ออกจากระบบไม่สำเร็จ: ' + error.message);
        return;
      }
      location.href = 'index.html';
    }

    window.updateStatus = updateStatus;
    window.logout = logout;
    window.showSection = showSection;
    window.markRoleChange = markRoleChange;
    window.saveRoleChange = saveRoleChange;

    init();
  </script>

</body>
</html>
