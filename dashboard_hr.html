<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; }
    .nav-link.active { background-color: #0d6efd !important; color: #fff !important; border-radius: .25rem; }
    canvas { background-color: #fff; border-radius: 8px; padding: 1rem; }
  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <div class="bg-light border-end p-3 vh-100" style="width: 250px;">
      <h4 class="mb-4">üìÅ ‡πÄ‡∏°‡∏ô‡∏π</h4>
      <ul class="nav flex-column">
        <li class="nav-item"><a href="#" class="nav-link text-dark" onclick="showSection('dashboard')">üìä Dashboard</a></li>
        <li class="nav-item"><a href="#" class="nav-link text-dark" onclick="showSection('requests')">üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</a></li>
        <li class="nav-item"><a href="#" class="nav-link text-dark" onclick="showSection('roles')">üõ°Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</a></li>
        <li class="nav-item mt-3"><button onclick="logout()" class="btn btn-danger w-100">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 p-4 bg-light">
      <div id="dashboardSection">
        <h2 class="mb-4">üìä Dashboard</h2>
        <div class="row g-4">
          <div class="col-md-6">
            <h5>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h5>
            <canvas id="leaveTypeChart" height="200"></canvas>
          </div>
          <div class="col-md-6">
            <h5>‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h5>
            <canvas id="leaveDepartmentChart" height="200"></canvas>
          </div>
        </div>
      </div>

      <div id="requestsSection" style="display: none;">
        <h2>üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <table class="table table-bordered table-sm" id="adminLeaveTable">
          <thead class="table-light">
            <tr>
              <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏≤</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="rolesSection" style="display: none;">
        <h2>üõ°Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <table class="table table-bordered table-sm" id="userRoleTable">
          <thead class="table-light">
            <tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th><th>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient('https://bokajbbrctsuqeyvykgb.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw');

    let chartType = null;
    let chartDept = null;

    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return location.href = 'index.html';

      const { data: userInfo } = await supabase.from('users').select('role').eq('id', user.id).maybeSingle();
      if (!userInfo || !['admin', 'hr'].includes(userInfo.role?.toLowerCase())) return location.href = 'index.html';

      await loadLeaveRequests();
      await loadLeaveTypeChart();
      await loadLeaveDepartmentChart();
    }

    async function loadUsers() {
      const { data: users, error } = await supabase.from('users').select('id, name, department, role');
      if (error) return alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);

      const tbody = document.querySelector('#userRoleTable tbody');
      tbody.innerHTML = '';
      users.forEach(user => {
        const selectHtml = `
          <select class="form-select form-select-sm" onchange="changeRole('${user.id}', this.value)">
            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
            <option value="hr" ${user.role === 'hr' ? 'selected' : ''}>HR</option>
          </select>`;
        tbody.innerHTML += `
          <tr><td>${user.name}</td><td>${user.department || '-'}</td><td>${user.role || '-'}</td><td>${selectHtml}</td></tr>`;
      });
    }

    window.changeRole = async (id, newRole) => {
      const { error } = await supabase.from('users').update({ role: newRole }).eq('id', id);
      if (error) alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
      else loadUsers();
    };

    function showSection(section) {
      ['dashboard', 'requests', 'roles'].forEach(id => {
        document.getElementById(id + 'Section').style.display = id === section ? 'block' : 'none';
      });
    }

    async function loadLeaveRequests() {
      const { data: leaveData } = await supabase.from('leave_requests').select('*').order('created_at', { ascending: false });
      const { data: users } = await supabase.from('users').select('id, name, department');
      const map = {}; users.forEach(u => map[u.id] = u);
      const tbody = document.querySelector('#adminLeaveTable tbody');
      tbody.innerHTML = '';

      leaveData.forEach(row => {
        const u = map[row.user_id] || { name: '-', department: '-' };
        const start = `${formatDate(row.date_start)} ${row.time_start || ''}`;
        const end = `${formatDate(row.date_end)} ${row.time_end || ''}`;
        const status = `<span class="badge bg-${statusColor(row.status)}">${row.status}</span>`;
        const buttons = row.status === 'pending' ? `
          <button class="btn btn-success btn-sm me-1" onclick="updateStatus('${row.id}', 'approved')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="btn btn-danger btn-sm" onclick="updateStatus('${row.id}', 'rejected')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>` : '-';
        tbody.innerHTML += `
          <tr><td>${u.name}</td><td>${u.department}</td><td>${row.leave_type}</td>
          <td>${start}</td><td>${end}</td><td>${row.leave_days}</td>
          <td>${leaveModeLabel(row.leave_mode)}</td><td>${row.reason || '-'}</td>
          <td>${status}</td><td>${buttons}</td></tr>`;
      });
    }

    async function updateStatus(id, status) {
      await supabase.from('leave_requests').update({ status }).eq('id', id);
      await loadLeaveRequests();
      await loadLeaveTypeChart();
      await loadLeaveDepartmentChart();
    }

    async function loadLeaveTypeChart() {
      const { data } = await supabase.from('leave_requests').select('leave_type, date_start, leave_days').eq('status', 'approved');
      const chartData = {}, months = new Set(), types = new Set();
      data.forEach(row => {
        const month = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
        const key = `${row.leave_type}-${month}`;
        chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
        months.add(month); types.add(row.leave_type);
      });
      const labels = [...months];
      const datasets = [...types].map(t => ({ label: t, data: labels.map(m => chartData[`${t}-${m}`] || 0), backgroundColor: randomColor() }));
      if (chartType) chartType.destroy();
      chartType = new Chart(document.getElementById('leaveTypeChart'), { type: 'bar', data: { labels, datasets } });
    }

    async function loadLeaveDepartmentChart() {
      const { data: leaveData } = await supabase.from('leave_requests').select('user_id, date_start, leave_days').eq('status', 'approved');
      const { data: users } = await supabase.from('users').select('id, department');
      const map = {}; users.forEach(u => map[u.id] = u.department);
      const chartData = {}, months = new Set(), depts = new Set();
      leaveData.forEach(row => {
        const dept = map[row.user_id] || '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
        const month = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
        const key = `${dept}-${month}`;
        chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
        months.add(month); depts.add(dept);
      });
      const labels = [...months];
      const datasets = [...depts].map(d => ({ label: d, data: labels.map(m => chartData[`${d}-${m}`] || 0), backgroundColor: randomColor() }));
      if (chartDept) chartDept.destroy();
      chartDept = new Chart(document.getElementById('leaveDepartmentChart'), { type: 'bar', data: { labels, datasets } });
    }

    function formatDate(d) {
      return new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    }
    function leaveModeLabel(m) {
      return { full: '‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô', half_morning: '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤', half_afternoon: '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢', hourly: '‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á' }[m] || '-';
    }
    function statusColor(s) {
      return { approved: 'success', rejected: 'danger', pending: 'secondary' }[s] || 'light';
    }
    function randomColor() {
      return 'hsl(' + Math.floor(Math.random() * 360) + ', 70%, 70%)';
    }

    async function logout() {
      await supabase.auth.signOut();
      location.href = 'index.html';
    }

    window.updateStatus = updateStatus;
    window.logout = logout;
    window.showSection = showSection;

    init();
  </script>
</body>
</html>
