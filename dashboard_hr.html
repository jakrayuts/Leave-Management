<!-- dashboard_hr.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>แดชบอร์ด HR</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    h2 { color: #764ba2; }
    button { margin-left: 1rem; }
  </style>
</head>
<body>
  <h2>แดชบอร์ดผู้อนุมัติ</h2>
  <h3>รายการคำขอลาทั้งหมด</h3>
  <ul id="leaveList"></ul>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabase = supabase.createClient(
      'https://leave-system.supabase.co',
      'YOUR-ANON-KEY'
    );

    async function fetchAllLeaveRequests() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) location.href = 'login.html';

      // สมมุติว่ามีตาราง users ที่เชื่อมกับ role
      const { data: userData } = await supabase
        .from('users')
        .select('role')
        .eq('id', user.id)
        .single();

      if (userData?.role !== 'HR' && userData?.role !== 'Manager') {
        alert("คุณไม่มีสิทธิ์เข้าใช้งานหน้านี้");
        return location.href = "login.html";
      }

      const { data, error } = await supabase
        .from('leave_requests')
        .select('*, users(name)')
        .order('created_at', { ascending: false });

      if (error) return alert('โหลดข้อมูลผิดพลาด');

      const list = document.getElementById('leaveList');
      list.innerHTML = '';

      data.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `${item.users.name}: ${item.leave_type} | ${item.date_start} - ${item.date_end} (${item.status})`;

        if (item.status === 'pending') {
          const approveBtn = document.createElement('button');
          approveBtn.textContent = '✅ อนุมัติ';
          approveBtn.onclick = () => updateStatus(item.id, 'approved');

          const rejectBtn = document.createElement('button');
          rejectBtn.textContent = '❌ ไม่อนุมัติ';
          rejectBtn.onclick = () => updateStatus(item.id, 'rejected');

          li.appendChild(approveBtn);
          li.appendChild(rejectBtn);
        }

        list.appendChild(li);
      });
    }

    async function updateStatus(id, status) {
      const { error } = await supabase
        .from('leave_requests')
        .update({ status })
        .eq('id', id);

      if (error) return alert("ไม่สามารถอัปเดตสถานะได้");
      alert("อัปเดตเรียบร้อย");
      fetchAllLeaveRequests();
    }

    fetchAllLeaveRequests();
  </script>
</body>
</html>
