<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>แดชบอร์ดแอดมิน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background-color: #f5f7fa;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    /* Sidebar */
    #sidebar {
      width: 260px;
      background-color: #4b2a86;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding-top: 1rem;
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
    }
    #sidebar h3 {
      text-align: center;
      margin-bottom: 2rem;
      font-weight: 700;
      letter-spacing: 1.5px;
    }
    #sidebar .nav-link {
      color: #d1c4e9;
      padding: 1rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #sidebar .nav-link:hover,
    #sidebar .nav-link.active {
      background-color: #6a4dc0;
      color: #fff;
    }

    /* Main content */
    #mainContent {
      flex-grow: 1;
      padding: 1.5rem 2rem;
      overflow-y: auto;
      background-color: #fff;
    }
    h2 {
      color: #4b2a86;
      margin-bottom: 1rem;
    }

    /* Tables */
    table {
      font-size: 0.9rem;
    }
    table thead {
      background-color: #6a4dc0;
      color: #fff;
    }
    table th, table td {
      vertical-align: middle !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
      }
      #sidebar .nav-link {
        flex: 1 0 auto;
        text-align: center;
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
      }
      #mainContent {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <nav id="sidebar">
    <h3>Admin Panel</h3>
    <div class="nav-link active" onclick="showSection('dashboard')">แดชบอร์ด</div>
    <div class="nav-link" onclick="showSection('requests')">คำขอลา</div>
    <div class="nav-link" onclick="showSection('roles')">จัดการสิทธิ์</div>
    <div class="nav-link text-danger mt-auto" onclick="logout()">ออกจากระบบ</div>
  </nav>

  <main id="mainContent">
    <!-- Dashboard -->
    <section id="dashboardSection">
      <h2>สรุปการลาแต่ละประเภท (รายเดือน)</h2>
      <canvas id="leaveTypeChart" height="120"></canvas>
    </section>

    <!-- Leave Requests -->
    <section id="requestsSection" style="display:none;">
      <h2>คำขอลาทั้งหมด</h2>
      <div class="table-responsive">
        <table class="table table-striped table-bordered" id="adminLeaveTable">
          <thead>
            <tr>
              <th>ชื่อ</th>
              <th>แผนก</th>
              <th>ประเภท</th>
              <th>เริ่ม</th>
              <th>สิ้นสุด</th>
              <th>จำนวนวัน</th>
              <th>โหมดลา</th>
              <th>เหตุผล</th>
              <th>สถานะ</th>
              <th>การจัดการ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- User Roles -->
    <section id="rolesSection" style="display:none;">
      <h2>จัดการสิทธิ์ผู้ใช้</h2>
      <div class="table-responsive">
        <table class="table table-striped table-bordered" id="userRoleTable">
          <thead>
            <tr>
              <th>ชื่อ</th>
              <th>อีเมล</th>
              <th>แผนก</th>
              <th>สิทธิ์</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabase = createClient(
      'https://bokajbbrctsuqeyvykgb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw'
    );

    let chart = null;

    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return location.href = 'index.html';

      const { data: userInfo } = await supabase.from('users').select('role').eq('id', user.id).maybeSingle();
      const role = userInfo?.role?.toLowerCase();
      if (!['admin', 'hr'].includes(role)) return location.href = 'index.html';

      await loadLeaveRequests();
      await loadLeaveTypeChart();
      await loadUserRoles();
    }

    async function loadLeaveRequests() {
      const { data: leaveData, error } = await supabase
        .from('leave_requests')
        .select('*')
        .order('created_at', { ascending: false });
      if (error) {
        alert('โหลดข้อมูลล้มเหลว: ' + error.message);
        return;
      }

      const { data: users, error: usersError } = await supabase
        .from('users')
        .select('id, name, department');
      if (usersError) {
        alert('โหลดข้อมูลผู้ใช้ล้มเหลว: ' + usersError.message);
        return;
      }

      const userMap = {};
      users.forEach(u => userMap[u.id] = { name: u.name || 'ไม่พบชื่อ', department: u.department || '-' });

      const tbody = document.querySelector('#adminLeaveTable tbody');
      tbody.innerHTML = '';

      leaveData.forEach(row => {
        const user = userMap[row.user_id] || { name: 'ไม่พบชื่อ', department: '-' };
        const start = `${formatDate(row.date_start)} ${row.time_start || ''}`;
        const end = `${formatDate(row.date_end)} ${row.time_end || ''}`;
        const mode = leaveModeLabel(row.leave_mode);
        const statusHtml = `<span class="badge bg-${statusColor(row.status)}">${row.status}</span>`;

        const buttons = row.status === 'pending' ? `
          <button class="btn btn-success btn-sm me-1" onclick="updateStatus('${row.id}', 'approved')">อนุมัติ</button>
          <button class="btn btn-danger btn-sm" onclick="updateStatus('${row.id}', 'rejected')">ปฏิเสธ</button>` : '-';

        tbody.innerHTML += `
          <tr>
            <td>${user.name}</td>
            <td>${user.department}</td>
            <td>${row.leave_type}</td>
            <td>${start}</td>
            <td>${end}</td>
            <td>${row.leave_days}</td>
            <td>${mode}</td>
            <td>${row.reason || '-'}</td>
            <td>${statusHtml}</td>
            <td>${buttons}</td>
          </tr>`;
      });
    }

    async function loadLeaveTypeChart() {
      const { data, error } = await supabase
        .from('leave_requests')
        .select('leave_type, date_start, leave_days')
        .eq('status', 'approved');

      if (error) return;

      const chartData = {};
      data.forEach(row => {
        const month = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
        const key = `${row.leave_type}-${month}`;
        chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
      });

      const months = [...new Set(data.map(r => new Date(r.date_start).toLocaleString('th-TH', { month: 'short' })))];
      const types = [...new Set(data.map(r => r.leave_type))];

      const datasets = types.map(type => ({
        label: type,
        data: months.map(month => chartData[`${type}-${month}`] || 0),
        backgroundColor: randomColor()
      }));

      if (chart) chart.destroy();
      const ctx = document.getElementById('leaveTypeChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: months, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'จำนวนวันลาแต่ละประเภท (รายเดือน)' }
          }
        }
      });
    }

    async function loadUserRoles() {
      const { data: users, error } = await supabase
        .from('users')
        .select('id, name, email, department, role')
        .order('name', { ascending: true });

      if (error) {
        alert('โหลดข้อมูลผู้ใช้ล้มเหลว: ' + error.message);
        return;
      }

      const tbody = document.querySelector('#userRoleTable tbody');
      tbody.innerHTML = '';

      users.forEach(u => {
        const roleOptions = ['Admin', 'HR', 'User'].map(r =>
          `<option value="${r}" ${u.role === r ? 'selected' : ''}>${r}</option>`
        ).join('');

        tbody.innerHTML += `
          <tr>
            <td>${u.name || '-'}</td>
            <td>${u.email || '-'}</td>
            <td>${u.department || '-'}</td>
            <td>
              <select class="form-select form-select-sm" onchange="changeUserRole('${u.id}', this.value)">
                ${roleOptions}
              </select>
            </td>
          </tr>
        `;
      });
    }

    window.changeUserRole = async function(userId, newRole) {
      const { error } = await supabase.from('users').update({ role: newRole }).eq('id', userId);
      if (error) {
        alert('ไม่สามารถเปลี่ยนสิทธิ์ได้: ' + error.message);
        console.error(error);
      } else {
        alert('อัปเดตสิทธิ์เรียบร้อย');
        await loadUserRoles();
      }
    };

    async function updateStatus(id, status) {
      const { error } = await supabase.from('leave_requests').update({ status }).eq('id', id);
      if (error) {
        alert('อัปเดตสถานะไม่สำเร็จ: ' + error.message);
        console.error(error);
      } else {
        await loadLeaveRequests();
        await loadLeaveTypeChart();
      }
    }

    function formatDate(d) {
      return new Date(d).toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function leaveModeLabel(mode) {
      return {
        full: 'เต็มวัน',
        half_morning: 'ครึ่งวันเช้า',
        half_afternoon: 'ครึ่งวันบ่าย',
        hourly: 'รายชั่วโมง'
      }[mode] || '-';
    }

    function statusColor(status) {
      return {
        approved: 'success',
        rejected: 'danger',
        pending: 'secondary'
      }[status] || 'light';
    }

    function randomColor() {
      return 'hsl(' + Math.floor(Math.random() * 360) + ', 70%, 70%)';
    }

    function showSection(section) {
      document.getElementById('dashboardSection').style.display = section === 'dashboard' ? 'block' : 'none';
      document.getElementById('requestsSection').style.display = section === 'requests' ? 'block' : 'none';
      document.getElementById('rolesSection').style.display = section === 'roles' ? 'block' : 'none';

      document.querySelectorAll('#sidebar .nav-link').forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');
    }

    async function logout() {
      await supabase.auth.signOut();
      location.href = 'index.html';
    }

    window.updateStatus = updateStatus;
    window.logout = logout;
    window.showSection = showSection;
    window.changeUserRole = window.changeUserRole || (() => {});

    init();
  </script>
</body>
</html>
