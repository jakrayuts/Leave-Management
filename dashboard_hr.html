<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แดชบอร์ดแอดมิน</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f6fa;
    }
    .sidebar {
      height: 100vh;
      background-color: #4b2a86;
      color: #fff;
      padding-top: 1rem;
    }
    .sidebar .nav-link {
      color: #fff;
    }
    .sidebar .nav-link.active {
      background-color: #341f66;
      border-radius: 0.375rem;
    }
    .content {
      padding: 2rem;
    }
    .chart-container {
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }
    .table-container {
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block sidebar">
        <div class="position-sticky">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" onclick="showSection('dashboard')"><i class="bi bi-bar-chart"></i> สถิติ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('requests')"><i class="bi bi-table"></i> คำขอลา</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="showSection('roles')"><i class="bi bi-people"></i> สิทธิ์ผู้ใช้</a>
            </li>
            <li class="nav-item mt-4">
              <a class="btn btn-light text-dark w-100" onclick="logout()">ออกจากระบบ</a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="content">
          <div id="dashboardSection" class="chart-container">
            <h4 class="mb-3">จำนวนวันลาแต่ละประเภท (รายเดือน)</h4>
            <canvas id="leaveTypeChart" height="100"></canvas>
          </div>

          <div id="requestsSection" class="table-container" style="display:none">
            <h4 class="mb-3">คำขอลาทั้งหมด</h4>
            <table class="table" id="adminLeaveTable">
              <thead>
                <tr>
                  <th>ชื่อ</th>
                  <th>แผนก</th>
                  <th>ประเภท</th>
                  <th>เริ่ม</th>
                  <th>สิ้นสุด</th>
                  <th>จำนวนวัน</th>
                  <th>โหมดลา</th>
                  <th>เหตุผล</th>
                  <th>สถานะ</th>
                  <th>การจัดการ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div id="rolesSection" class="table-container" style="display:none">
            <h4>จัดการสิทธิ์ผู้ใช้ (เร็วๆ นี้)</h4>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const supabase = createClient(
      'https://bokajbbrctsuqeyvykgb.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw'
    );

    let chart = null;

    async function init() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return location.href = 'index.html';

      const { data: userInfo } = await supabase.from('users').select('role').eq('id', user.id).maybeSingle();
      const role = userInfo?.role?.toLowerCase();
      if (!['admin', 'hr'].includes(role)) return location.href = 'index.html';

      await loadLeaveRequests();
      await loadLeaveTypeChart();
    }

    async function loadLeaveRequests() {
      const { data: leaveData } = await supabase.from('leave_requests').select('*').order('created_at', { ascending: false });
      const { data: users } = await supabase.from('users').select('id, name, department');

      const userMap = {};
      users.forEach(u => userMap[u.id] = { name: u.name, department: u.department });

      const tbody = document.querySelector('#adminLeaveTable tbody');
      tbody.innerHTML = '';

      leaveData.forEach(row => {
        const user = userMap[row.user_id] || { name: 'ไม่พบชื่อ', department: '-' };
        const start = `${formatDate(row.date_start)} ${row.time_start || ''}`;
        const end = `${formatDate(row.date_end)} ${row.time_end || ''}`;
        const mode = leaveModeLabel(row.leave_mode);
        const statusHtml = `<span class="badge bg-${statusColor(row.status)}">${row.status}</span>`;

        const buttons = row.status === 'pending' ? `
          <button class="btn btn-success btn-sm me-1" onclick="updateStatus('${row.id}', 'approved')">อนุมัติ</button>
          <button class="btn btn-danger btn-sm" onclick="updateStatus('${row.id}', 'rejected')">ปฏิเสธ</button>` : '-';

        tbody.innerHTML += `
          <tr>
            <td>${user.name}</td>
            <td>${user.department}</td>
            <td>${row.leave_type}</td>
            <td>${start}</td>
            <td>${end}</td>
            <td>${row.leave_days}</td>
            <td>${mode}</td>
            <td>${row.reason || '-'}</td>
            <td>${statusHtml}</td>
            <td>${buttons}</td>
          </tr>`;
      });
    }

    async function loadLeaveTypeChart() {
      const { data } = await supabase.from('leave_requests').select('leave_type, date_start, leave_days').eq('status', 'approved');
      const chartData = {};

      data.forEach(row => {
        const month = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
        const key = `${row.leave_type}-${month}`;
        chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
      });

      const months = [...new Set(data.map(r => new Date(r.date_start).toLocaleString('th-TH', { month: 'short' })))];
      const types = [...new Set(data.map(r => r.leave_type))];

      const datasets = types.map(type => ({
        label: type,
        data: months.map(month => chartData[`${type}-${month}`] || 0),
        backgroundColor: randomColor()
      }));

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('leaveTypeChart'), {
        type: 'bar',
        data: { labels: months, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'จำนวนวันลาแต่ละประเภท (รายเดือน)' }
          }
        }
      });
    }

    async function updateStatus(id, status) {
      await supabase.from('leave_requests').update({ status }).eq('id', id);
      await loadLeaveRequests();
      await loadLeaveTypeChart();
    }

    function formatDate(d) {
      return new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function leaveModeLabel(mode) {
      return { full: 'เต็มวัน', half_morning: 'ครึ่งวันเช้า', half_afternoon: 'ครึ่งวันบ่าย', hourly: 'รายชั่วโมง' }[mode] || '-';
    }

    function statusColor(status) {
      return { approved: 'success', rejected: 'danger', pending: 'secondary' }[status] || 'light';
    }

    function randomColor() {
      return 'hsl(' + Math.floor(Math.random() * 360) + ', 70%, 70%)';
    }

    function showSection(section) {
      document.getElementById('dashboardSection').style.display = section === 'dashboard' ? 'block' : 'none';
      document.getElementById('requestsSection').style.display = section === 'requests' ? 'block' : 'none';
      document.getElementById('rolesSection').style.display = section === 'roles' ? 'block' : 'none';
      document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
      event.target.classList.add('active');
    }

    async function logout() {
      await supabase.auth.signOut();
      location.href = 'index.html';
    }

    window.updateStatus = updateStatus;
    window.logout = logout;
    window.showSection = showSection;

    init();
  </script>
</body>
</html>
