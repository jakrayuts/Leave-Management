<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #f9f9f9; margin: 0; }
    .sidebar { width: 250px; background-color: #343a40; color: white; min-height: 100vh; padding: 1rem; }
    .sidebar .nav-link { color: white; }
    .sidebar .nav-link.active { background-color: #0d6efd; border-radius: 0.25rem; }
    .main { padding: 2rem; flex-grow: 1; }
    canvas { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
<div class="d-flex">
  <!-- Sidebar -->
  <div class="sidebar">
    <h4 class="mb-4">‡πÄ‡∏°‡∏ô‡∏π</h4>
    <ul class="nav flex-column">
      <li class="nav-item"><a href="#" class="nav-link" onclick="showSection('dashboard')">üìä Dashboard</a></li>
      <li class="nav-item"><a href="#" class="nav-link" onclick="showSection('requests')">üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</a></li>
      <li class="nav-item"><a href="#" class="nav-link" onclick="showSection('roles')">üõ°Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</a></li>
      <li class="nav-item"><a href="#" class="nav-link" onclick="showSection('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a></li> 
      <li class="nav-item mt-3"><button onclick="logout()" class="btn btn-danger w-100">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div id="dashboardSection">
      <h2>üìä Dashboard</h2>
      <div class="row">
        <div class="col-md-6">
          <h5>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h5>
          <canvas id="leaveTypeChart" height="200"></canvas>
        </div>
        <div class="col-md-6">
          <h5>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h5>
          <canvas id="leaveDepartmentChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div id="requestsSection" style="display: none;">
      <h2>üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      <table class="table" id="adminLeaveTable">
        <thead><tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏≤</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="rolesSection" style="display: none;">
      <h2>üõ°Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
      <div id="roleManagerTable"></div>
    </div>
  </div>
</div>
<!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Section ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
    <div id="reportsSection" style="display: none; padding: 1rem;">
      <h2>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h2>
      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
      <form id="reportFilterForm" class="row g-3 mb-3">
        <div class="col-md-3">
          <label for="reportType" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
          <select id="reportType" class="form-select">
            <option value="detailed">‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</option>
            <option value="summary">‡πÅ‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="departmentSelect" class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <select id="departmentSelect" class="form-select">
            <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
            <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
          </select>
        </div>

        <div class="col-md-3">
          <label for="employeeSelect" class="form-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <select id="employeeSelect" class="form-select">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>
            <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
          </select>
        </div>

        <div class="col-md-3">
          <label for="monthPicker" class="form-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input type="month" id="monthPicker" class="form-control" />
        </div>

        <div class="col-md-3">
          <label for="displayType" class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label>
          <select id="displayType" class="form-select">
            <option value="table">‡∏ï‡∏≤‡∏£‡∏≤‡∏á</option>
            <option value="chart">‡∏Å‡∏£‡∏≤‡∏ü</option>
          </select>
        </div>

        <div class="col-md-3 align-self-end">
          <button type="button" id="btnGenerate" class="btn btn-primary">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="col-md-6 align-self-end text-end">
          <button type="button" id="btnExportPdf" class="btn btn-danger">Export PDF</button>
          <button type="button" id="btnExportExcel" class="btn btn-success">Export Excel</button>
        </div>
      </form>

      <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
      <div id="reportResult"></div>
       </div>
  </div>
</div>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const supabase = createClient('https://bokajbbrctsuqeyvykgb.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw');

  let chartType = null;
  let chartDept = null;

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return location.href = 'index.html';

    const { data: userInfo } = await supabase.from('users').select('role').eq('id', user.id).maybeSingle();
    if (!userInfo || !['admin', 'hr'].includes(userInfo.role?.toLowerCase())) return location.href = 'index.html';

    await loadLeaveRequests();
    await loadLeaveTypeChart();
    await loadLeaveDepartmentChart();
  }

  async function loadLeaveRequests() {
    const { data: leaveData } = await supabase.from('leave_requests').select('*').order('created_at', { ascending: false });
    const { data: users } = await supabase.from('users').select('id, name, department');
    const userMap = {}; users.forEach(u => userMap[u.id] = u);

    const tbody = document.querySelector('#adminLeaveTable tbody');
    tbody.innerHTML = '';
    leaveData.forEach(row => {
      const u = userMap[row.user_id] || { name: '-', department: '-' };
      tbody.innerHTML += `
        <tr>
          <td>${u.name}</td><td>${u.department}</td><td>${row.leave_type}</td>
          <td>${formatDate(row.date_start)} ${row.time_start || ''}</td>
          <td>${formatDate(row.date_end)} ${row.time_end || ''}</td>
          <td>${row.leave_days}</td><td>${leaveModeLabel(row.leave_mode)}</td>
          <td>${row.reason || '-'}</td>
          <td><span class="badge bg-${statusColor(row.status)}">${row.status}</span></td>
          <td>${row.status === 'pending' ? `
            <button class='btn btn-success btn-sm me-1' onclick="updateStatus('${row.id}', 'approved')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class='btn btn-danger btn-sm' onclick="updateStatus('${row.id}', 'rejected')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>` : '-'}</td>
        </tr>`;
    });
  }

  async function loadLeaveTypeChart() {
    const { data } = await supabase.from('leave_requests').select('leave_type, date_start, leave_days').eq('status', 'approved');
    const chartData = {}, months = new Set(), types = new Set();
    data.forEach(row => {
      const m = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
      const key = `${row.leave_type}-${m}`;
      chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
      months.add(m); types.add(row.leave_type);
    });
    const labels = [...months];
    const datasets = [...types].map(t => ({ label: t, data: labels.map(m => chartData[`${t}-${m}`] || 0), backgroundColor: randomColor() }));
    if (chartType) chartType.destroy();
    chartType = new Chart(document.getElementById('leaveTypeChart'), { type: 'bar', data: { labels, datasets } });
  }

  async function loadLeaveDepartmentChart() {
    const { data: leaveData } = await supabase.from('leave_requests').select('user_id, date_start, leave_days').eq('status', 'approved');
    const { data: users } = await supabase.from('users').select('id, department');
    const map = {}; users.forEach(u => map[u.id] = u.department);
    const chartData = {}, months = new Set(), depts = new Set();
    leaveData.forEach(row => {
      const m = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
      const dept = map[row.user_id] || '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
      const key = `${dept}-${m}`;
      chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
      months.add(m); depts.add(dept);
    });
    const labels = [...months];
    const datasets = [...depts].map(d => ({ label: d, data: labels.map(m => chartData[`${d}-${m}`] || 0), backgroundColor: randomColor() }));
    if (chartDept) chartDept.destroy();
    chartDept = new Chart(document.getElementById('leaveDepartmentChart'), { type: 'bar', data: { labels, datasets } });
  }

  async function updateStatus(id, status) {
    await supabase.from('leave_requests').update({ status }).eq('id', id);
    await loadLeaveRequests();
    await loadLeaveTypeChart();
    await loadLeaveDepartmentChart();
  }

  function formatDate(d) {
    return new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  function leaveModeLabel(m) {
    return { full: '‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô', half_morning: '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤', half_afternoon: '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢', hourly: '‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á' }[m] || '-';
  }
  function statusColor(s) {
    return { approved: 'success', rejected: 'danger', pending: 'secondary' }[s] || 'light';
  }
  function randomColor() {
    return 'hsl(' + Math.floor(Math.random() * 360) + ', 70%, 70%)';
  }
  async function logout() {
    await supabase.auth.signOut();
    location.href = 'index.html';
  }
  function showSection(section) {
    ['dashboard', 'requests', 'roles'].forEach(id => {
      document.getElementById(id + 'Section').style.display = id === section ? 'block' : 'none';
    });
    if (section === 'roles') loadUsers();
  }

  async function loadUsers() {
    const { data: users } = await supabase.from('users').select('id, name, department, role');
    const roles = ['User', 'HR', 'Admin', 'Supervisor'];
    const html = `<table class="table table-bordered table-sm">
      <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th><th>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th></tr></thead>
      <tbody>
        ${users.map(u => `
          <tr>
            <td>${u.name}</td><td>${u.department}</td><td>${u.role}</td>
            <td><select class="form-select form-select-sm" onchange="changeRole('${u.id}', this.value)">
              ${roles.map(r => `<option value="${r}" ${r === u.role ? 'selected' : ''}>${r}</option>`).join('')}
            </select></td>
          </tr>`).join('')}
      </tbody></table>`;
    document.getElementById('roleManagerTable').innerHTML = html;
  }

  window.updateStatus = updateStatus;
  window.logout = logout;
  window.showSection = showSection;
  window.changeRole = async (id, newRole) => {
    await supabase.from('users').update({ role: newRole }).eq('id', id);
    loadUsers();
  };

  init();
</script>
</body>
</html>
