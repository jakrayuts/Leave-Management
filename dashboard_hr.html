<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #f9f9f9; margin: 0; }
    .sidebar { width: 250px; background-color: #343a40; color: white; min-height: 100vh; padding: 1rem; }
    .sidebar .nav-link { color: white; cursor: pointer; }
    .sidebar .nav-link.active { background-color: #0d6efd; border-radius: 0.25rem; }
    .main { padding: 2rem; flex-grow: 1; }
    canvas { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
<div class="d-flex">
  <!-- Sidebar -->
  <div class="sidebar">
    <h4 class="mb-4">‡πÄ‡∏°‡∏ô‡∏π</h4>
    <ul class="nav flex-column">
      <li class="nav-item"><a class="nav-link" onclick="showSection('dashboard')">üìä Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showSection('requests')">üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showSection('roles')">üõ°Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</a></li>
      <li class="nav-item"><a class="nav-link" onclick="showSection('reports')">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a></li>  <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
      <li class="nav-item mt-3"><button onclick="logout()" class="btn btn-danger w-100">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div id="dashboardSection">
      <h2>üìä Dashboard</h2>
      <div class="row">
        <div class="col-md-6">
          <h5>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h5>
          <canvas id="leaveTypeChart" height="200"></canvas>
        </div>
        <div class="col-md-6">
          <h5>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h5>
          <canvas id="leaveDepartmentChart" height="200"></canvas>
        </div>
      </div>
    </div>

    <div id="requestsSection" style="display: none;">
      <h2>üìÑ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
      <table class="table" id="adminLeaveTable">
        <thead><tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th>‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th>
          <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏≤</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="rolesSection" style="display: none;">
      <h2>üõ°Ô∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
      <div id="roleManagerTable"></div>
    </div>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏° Section ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
    <div id="reportsSection" style="display: none; padding: 1rem;">
      <h2>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h2>
      <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
      <form id="reportFilterForm" class="row g-3 mb-3">
        <div class="col-md-3">
          <label for="reportType" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
          <select id="reportType" class="form-select">
            <option value="detailed">‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</option>
            <option value="summary">‡πÅ‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="departmentSelect" class="form-label">‡πÅ‡∏ú‡∏ô‡∏Å</label>
          <select id="departmentSelect" class="form-select">
            <option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
            <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
          </select>
        </div>

        <div class="col-md-3">
          <label for="employeeSelect" class="form-label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <select id="employeeSelect" class="form-select">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>
            <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
          </select>
        </div>

        <div class="col-md-3">
          <label for="monthPicker" class="form-label">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
          <input type="month" id="monthPicker" class="form-control" />
        </div>

        <div class="col-md-3">
          <label for="displayType" class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</label>
          <select id="displayType" class="form-select">
            <option value="table">‡∏ï‡∏≤‡∏£‡∏≤‡∏á</option>
            <option value="chart">‡∏Å‡∏£‡∏≤‡∏ü</option>
          </select>
        </div>

        <div class="col-md-3 align-self-end">
          <button type="button" id="btnGenerate" class="btn btn-primary">‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
        </div>

        <div class="col-md-6 align-self-end text-end">
          <button type="button" id="btnExportPdf" class="btn btn-danger">Export PDF</button>
          <button type="button" id="btnExportExcel" class="btn btn-success">Export Excel</button>
        </div>
      </form>

      <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
      <div id="reportResult"></div>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  import jsPDF from 'https://cdn.jsdelivr.net/npm/jspdf/+esm';
  import XLSX from 'https://cdn.jsdelivr.net/npm/xlsx/+esm';

  const supabase = createClient(
    'https://bokajbbrctsuqeyvykgb.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJva2FqYmJyY3RzdXFleXZ5a2diIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1NzM5NzksImV4cCI6MjA2NjE0OTk3OX0.ZLLi-wTqCmfzKs2ere8OsQXkAXsUfsBhF65I0UGptvw'
  );

  let chartType = null;
  let chartDept = null;
  let reportChart = null; // ‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return location.href = 'index.html';

    const { data: userInfo } = await supabase.from('users').select('role').eq('id', user.id).maybeSingle();
    if (!userInfo || !['admin', 'hr'].includes(userInfo.role?.toLowerCase())) return location.href = 'index.html';

    await loadLeaveRequests();
    await loadLeaveTypeChart();
    await loadLeaveDepartmentChart();
    await loadUsers();
    await loadDepartmentsAndEmployees(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÉ‡∏™‡πà‡πÉ‡∏ô select filter ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  async function loadDepartmentsAndEmployees() {
    // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
    const { data: users, error: userError } = await supabase.from('users').select('id, name, department');
    if (userError) return console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', userError);

    // ‡∏´‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
    const departments = [...new Set(users.map(u => u.department).filter(Boolean))].sort();

    const departmentSelect = document.getElementById('departmentSelect');
    departmentSelect.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>`;
    departments.forEach(d => {
      departmentSelect.innerHTML += `<option value="${d}">${d}</option>`;
    });

    const employeeSelect = document.getElementById('employeeSelect');
    employeeSelect.innerHTML = `<option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>`;
    users.forEach(u => {
      employeeSelect.innerHTML += `<option value="${u.id}">${u.name}</option>`;
    });
  }

  document.getElementById('btnGenerate').addEventListener('click', async () => {
    const reportType = document.getElementById('reportType').value;
    const department = document.getElementById('departmentSelect').value;
    const employee = document.getElementById('employeeSelect').value;
    const month = document.getElementById('monthPicker').value; // yyyy-mm
    const displayType = document.getElementById('displayType').value;

    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    let startDate, endDate;
    if (month) {
      startDate = new Date(month + '-01');
      endDate = new Date(startDate);
      endDate.setMonth(endDate.getMonth() + 1);
      endDate.setDate(endDate.getDate() - 1);
    }

    // Query data ‡∏à‡∏≤‡∏Å Supabase
    let query = supabase.from('leave_requests').select(`
      user:user_id(id, name, department),
      leave_type, date_start, date_end, leave_days, leave_mode, reason, status
    `).eq('status', 'approved');

    if (department) query = query.eq('user.department', department);
    if (employee) query = query.eq('user.id', employee);
    if (startDate && endDate) query = query.gte('date_start', startDate.toISOString()).lte('date_end', endDate.toISOString());

    const { data, error } = await query;
    if (error) return alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);

    if (displayType === 'table') {
      renderTable(data, reportType);
    } else {
      renderChart(data, reportType);
    }
  });

  function renderTable(data, reportType) {
    const container = document.getElementById('reportResult');
    if (!data || data.length === 0) {
      container.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
      return;
    }
    if (reportType === 'detailed') {
      let html = `<table class="table table-striped"><thead><tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏≤</th><th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
      </tr></thead><tbody>`;
      data.forEach(r => {
        html += `<tr>
          <td>${r.user?.name || '-'}</td>
          <td>${r.user?.department || '-'}</td>
          <td>${r.leave_type}</td>
          <td>${new Date(r.date_start).toLocaleDateString()}</td>
          <td>${new Date(r.date_end).toLocaleDateString()}</td>
          <td>${r.leave_days}</td>
          <td>${leaveModeLabel(r.leave_mode)}</td>
          <td>${r.reason || '-'}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    } else if (reportType === 'summary') {
      // ‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°: ‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      const summary = {};
      data.forEach(r => {
        const key = r.leave_type;
        summary[key] = (summary[key] || 0) + r.leave_days;
      });
      let html = `<table class="table table-striped"><thead><tr><th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th></tr></thead><tbody>`;
      Object.entries(summary).forEach(([type, days]) => {
        html += `<tr><td>${type}</td><td>${days}</td></tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    if(reportChart){
      reportChart.destroy();
      reportChart = null;
    }
  }

  function renderChart(data, reportType) {
    const container = document.getElementById('reportResult');
    if (!data || data.length === 0) {
      container.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
      return;
    }
    container.innerHTML = `<canvas id="reportChart"></canvas>`;
    const ctx = document.getElementById('reportChart').getContext('2d');

    const summary = {};
    data.forEach(r => {
      const key = r.leave_type;
      summary[key] = (summary[key] || 0) + r.leave_days;
    });

    const labels = Object.keys(summary);
    const values = Object.values(summary);

    if(reportChart){
      reportChart.destroy();
    }
    reportChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤',
          data: values,
          backgroundColor: labels.map(() => randomColor())
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: '‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤ ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤' }
        }
      }
    });
  }

  // Export PDF (jsPDF)
  document.getElementById('btnExportPdf').addEventListener('click', () => {
    const container = document.getElementById('reportResult');
    if (!container.innerText.trim()) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');

    const doc = new jsPDF();
    doc.text('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤', 10, 10);
    doc.text(container.innerText, 10, 20);
    doc.save('report_leave.pdf');
  });

  // Export Excel (SheetJS)
  document.getElementById('btnExportExcel').addEventListener('click', () => {
    const container = document.getElementById('reportResult');
    if (!container.innerText.trim()) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');

    /* ‡∏™‡∏£‡πâ‡∏≤‡∏á workbook ‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
    const table = container.querySelector('table');
    if (!table) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');

    const workbook = XLSX.utils.table_to_book(table, { sheet: "Report" });
    XLSX.writeFile(workbook, 'report_leave.xlsx');
  });

  async function loadLeaveRequests() {
    const { data: leaveData } = await supabase.from('leave_requests').select('*').order('created_at', { ascending: false });
    const { data: users } = await supabase.from('users').select('id, name, department');
    const userMap = {}; users.forEach(u => userMap[u.id] = u);

    const tbody = document.querySelector('#adminLeaveTable tbody');
    tbody.innerHTML = '';
    leaveData.forEach(row => {
      const u = userMap[row.user_id] || { name: '-', department: '-' };
      tbody.innerHTML += `
        <tr>
          <td>${u.name}</td><td>${u.department}</td><td>${row.leave_type}</td>
          <td>${formatDate(row.date_start)} ${row.time_start || ''}</td>
          <td>${formatDate(row.date_end)} ${row.time_end || ''}</td>
          <td>${row.leave_days}</td><td>${leaveModeLabel(row.leave_mode)}</td>
          <td>${row.reason || '-'}</td>
          <td><span class="badge bg-${statusColor(row.status)}">${row.status}</span></td>
          <td>${row.status === 'pending' ? `
            <button class='btn btn-success btn-sm me-1' onclick="updateStatus('${row.id}', 'approved')">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class='btn btn-danger btn-sm' onclick="updateStatus('${row.id}', 'rejected')">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>` : '-'}</td>
        </tr>`;
    });
  }

  async function loadLeaveTypeChart() {
    const { data } = await supabase.from('leave_requests').select('leave_type, date_start, leave_days').eq('status', 'approved');
    const chartData = {}, months = new Set(), types = new Set();
    data.forEach(row => {
      const m = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
      const key = `${row.leave_type}-${m}`;
      chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
      months.add(m); types.add(row.leave_type);
    });
    const labels = [...months];
    const datasets = [...types].map(t => ({ label: t, data: labels.map(m => chartData[`${t}-${m}`] || 0), backgroundColor: randomColor() }));
    if (chartType) chartType.destroy();
    chartType = new Chart(document.getElementById('leaveTypeChart'), { type: 'bar', data: { labels, datasets } });
  }

  async function loadLeaveDepartmentChart() {
    const { data: leaveData } = await supabase.from('leave_requests').select('user_id, date_start, leave_days').eq('status', 'approved');
    const { data: users } = await supabase.from('users').select('id, department');
    const map = {}; users.for
Each(u => map[u.id] = u.department);
const chartData = {}, months = new Set(), depts = new Set();
leaveData.forEach(row => {
const m = new Date(row.date_start).toLocaleString('th-TH', { month: 'short' });
const dept = map[row.user_id] || '‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
const key = ${dept}-${m};
chartData[key] = (chartData[key] || 0) + parseFloat(row.leave_days);
months.add(m); depts.add(dept);
});
const labels = [...months];
const datasets = [...depts].map(d => ({ label: d, data: labels.map(m => chartData[${d}-${m}] || 0), backgroundColor: randomColor() }));
if (chartDept) chartDept.destroy();
chartDept = new Chart(document.getElementById('leaveDepartmentChart'), { type: 'bar', data: { labels, datasets } });
}

async function updateStatus(id, status) {
if (!confirm(‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ ${status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'} ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ?)) return;
await supabase.from('leave_requests').update({ status }).eq('id', id);
await loadLeaveRequests();
}

function formatDate(d) {
const date = new Date(d);
return date.toLocaleDateString('th-TH');
}

function statusColor(status) {
return status === 'approved' ? 'success' : status === 'rejected' ? 'danger' : 'secondary';
}

function leaveModeLabel(mode) {
return mode === 'half_morning' ? '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏ä‡πâ‡∏≤' : mode === 'half_afternoon' ? '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≤‡∏¢' : mode === 'hourly' ? '‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á' : '‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô';
}

function randomColor() {
return hsl(${Math.random() * 360}, 60%, 60%);
}

async function loadUsers() {
const { data } = await supabase.from('users').select('id, email, name, role');
const div = document.getElementById('roleManagerTable');
div.innerHTML = <table class="table"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>Role</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr></thead><tbody> ${data.map(u =>
<tr>
<td>${u.name}</td>
<td>${u.email}</td>
<td><select class="form-select form-select-sm" data-id="${u.id}">
<option value="user" ${u.role === 'user' ? 'selected' : ''}>user</option>
<option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
<option value="hr" ${u.role === 'hr' ? 'selected' : ''}>hr</option>
</select></td>
<td><button class="btn btn-sm btn-primary" onclick="updateRole('${u.id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></td>
</tr>).join('')}</tbody></table>;
}

async function updateRole(userId) {
const select = document.querySelector(select[data-id="${userId}"]);
await supabase.from('users').update({ role: select.value }).eq('id', userId);
alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï role ‡πÅ‡∏•‡πâ‡∏ß');
}

// ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Section ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
function showSection(section) {
['dashboard', 'requests', 'roles', 'reports'].forEach(id => {
document.getElementById(id + 'Section').style.display = id === section ? 'block' : 'none';
});
if (section === 'roles') loadUsers();
}

async function logout() {
await supabase.auth.signOut();
location.href = 'index.html';
}

init();
</script>
</body> 
</html>
