<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>แบบฟอร์มขอลา</title>
</head>
<body>

  <h2>แบบฟอร์มขอลา</h2>

  <form id="leaveForm">
    <label>ชื่อผู้ใช้</label>
    <select id="userSelect" name="user_id" required>
      <option value="">-- เลือกผู้ใช้ --</option>
    </select>

    <br/><br/>

    <label>ประเภทการลา</label>
    <select name="leave_type" required>
      <option value="ลากิจ">ลากิจ</option>
      <option value="ลาป่วย">ลาป่วย</option>
    </select>

    <br/><br/>

    <label>เหตุผล</label>
    <textarea name="reason" required></textarea>

    <br/><br/>

    <label>วันที่เริ่ม</label>
    <input type="date" name="date_start" required />

    <br/><br/>

    <label>วันที่สิ้นสุด</label>
    <input type="date" name="date_end" required />

    <br/><br/>

    <button type="submit">ส่งคำขอ</button>
  </form>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    // กำหนด Supabase URL และ Anon Key ของคุณ
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY";

    // สร้าง client เชื่อมต่อ Supabase
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // โหลดรายชื่อผู้ใช้จากตาราง users แล้วเติมลง select
    async function loadUsers() {
      const { data, error } = await supabase.from('users').select('id, name');
      if (error) {
        alert("โหลดรายชื่อผู้ใช้ล้มเหลว: " + error.message);
        return;
      }

      const userSelect = document.getElementById('userSelect');
      data.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id; // ใช้ id เป็นค่า value
        option.textContent = user.name;
        userSelect.appendChild(option);
      });
    }

    loadUsers();

    // จับ submit form
    document.getElementById('leaveForm').addEventListener('submit', async e => {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);

      // สร้างอ็อบเจกต์ข้อมูลจากฟอร์ม
      const leaveData = {
        user_id: formData.get('user_id'),
        leave_type: formData.get('leave_type'),
        reason: formData.get('reason'),
        date_start: formData.get('date_start'),
        date_end: formData.get('date_end'),
        status: 'pending', // กำหนดสถานะเริ่มต้น
        created_at: new Date().toISOString()
      };

      // ส่งข้อมูลไปเก็บในตาราง leave_requests
      const { data, error } = await supabase.from('leave_requests').insert([leaveData]);

      if (error) {
        alert("ส่งคำขอลาล้มเหลว: " + error.message);
      } else {
        alert("ส่งคำขอลาสำเร็จ!");
        form.reset();
      }
    });
  </script>
</body>
</html>
