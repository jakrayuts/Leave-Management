<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบขอลา - Frontend</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">

  <div class="container mt-5">
    <h2 class="mb-4">ระบบขอลา</h2>

    <!-- ฟอร์มส่งคำขอลา -->
    <form id="leaveForm" class="mb-4">
      <div class="mb-3">
        <label for="leave_type" class="form-label">ประเภทการลา</label>
        <select id="leave_type" name="leave_type" class="form-select" required>
          <option value="">-- เลือกประเภทลา --</option>
          <option value="ลากิจ">ลากิจ</option>
          <option value="ลาป่วย">ลาป่วย</option>
          <option value="ลาพักร้อน">ลาพักร้อน</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="reason" class="form-label">เหตุผลการลา</label>
        <textarea id="reason" name="reason" class="form-control" rows="3" required></textarea>
      </div>

      <div class="row mb-3">
        <div class="col">
          <label for="date_start" class="form-label">วันที่เริ่ม</label>
          <input type="date" id="date_start" name="date_start" class="form-control" required />
        </div>
        <div class="col">
          <label for="date_end" class="form-label">วันที่สิ้นสุด</label>
          <input type="date" id="date_end" name="date_end" class="form-control" required />
        </div>
      </div>

      <button type="submit" class="btn btn-primary">ส่งคำขอ</button>
    </form>

    <!-- ตารางแสดงคำขอลาที่ส่ง -->
    <h4>คำขอลาของฉัน</h4>
    <table class="table table-bordered" id="leaveTable">
      <thead class="table-light">
        <tr>
          <th>ประเภท</th>
          <th>เหตุผล</th>
          <th>วันที่เริ่ม</th>
          <th>วันที่สิ้นสุด</th>
          <th>สถานะ</th>
          <th>วันที่ส่ง</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

<script>
  // สมมติ API base URL
  const API_BASE = 'https://your-api.example.com';

  // ดึงคำขอลาของ user ปัจจุบัน (ตัวอย่างใช้ user_id จาก session/localStorage)
  const userId = localStorage.getItem('user_id') || 'test-user-uuid';

  // ฟังก์ชันดึงข้อมูลคำขอของ user
  async function fetchLeaves() {
    try {
      const res = await fetch(`${API_BASE}/leave-requests?user_id=${userId}`);
      if (!res.ok) throw new Error('ไม่สามารถดึงข้อมูลคำขอได้');
      const data = await res.json();
      populateTable(data);
    } catch (err) {
      alert(err.message);
    }
  }

  // ฟังก์ชันเติมข้อมูลลงตาราง
  function populateTable(leaves) {
    const tbody = document.querySelector('#leaveTable tbody');
    tbody.innerHTML = ''; // เคลียร์ก่อน

    leaves.forEach(lv => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${lv.leave_type}</td>
        <td>${lv.reason}</td>
        <td>${lv.date_start}</td>
        <td>${lv.date_end}</td>
        <td>${lv.status}</td>
        <td>${new Date(lv.created_at).toLocaleDateString()}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ส่งคำขอลาใหม่
  document.getElementById('leaveForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;

    // เตรียมข้อมูลจากฟอร์ม
    const data = {
      user_id: userId,
      leave_type: form.leave_type.value,
      reason: form.reason.value,
      date_start: form.date_start.value,
      date_end: form.date_end.value,
    };

    try {
      const res = await fetch(`${API_BASE}/leave-requests`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error('ส่งคำขอไม่สำเร็จ');
      alert('ส่งคำขอสำเร็จ');
      form.reset();
      fetchLeaves();  // โหลดใหม่หลังส่งคำขอ
    } catch (err) {
      alert(err.message);
    }
  });

  // โหลดข้อมูลคำขอลาเมื่อเปิดหน้า
  fetchLeaves();
</script>

</body>
</html>
